//
//  OCRNportal.m
//  CourseCC
//
//  Created by Luther Tsai on 2015/4/17.
//  Copyright (c) 2015å¹´ Luther Tsai. All rights reserved.
//

#import "OCRNportal.h"

@implementation OCRNportal

-(id) init;
{
    self = [super init];
    
    if (self) {
        
    }
    return  self;
}

- (NSString *)OCRnPortalWithImage:(UIImage *)authImage
{
    NSArray *imageArray = [self getRGBAsFromImage:authImage atX:0 andY:0 count:authImage.size.width * authImage.size.height];
    return [self outputTextDataFromArray:imageArray];
}

- (NSString *)outputTextDataFromArray:(NSArray *)inputArray
{
    NSString *authCode = [[NSString alloc] initWithFormat:@""];
    NSString *emptyString = [[NSString alloc] initWithFormat:@""];
    for (int i = 0; i < 90; i++) {
        for (int j = 0; j < 30; j++) {
            NSString *data = [NSString stringWithFormat:@"%@", [inputArray objectAtIndex:(90 * j + i)]];
            emptyString = [emptyString stringByAppendingString:data];
        }
        //emptyString = [emptyString stringByAppendingString:[NSString stringWithFormat:@"\n"]];
        if ((i + 1) % 22 == 0) {
            authCode = [authCode stringByAppendingString:[self OCRwithCharacterImageString:emptyString]];
            emptyString = [[NSString alloc] initWithFormat:@""];
        }
        
    }
    return authCode;
}

- (NSArray*)getRGBAsFromImage:(UIImage*)image atX:(int)x andY:(int)y count:(int)count
{
    NSMutableArray *result = [NSMutableArray arrayWithCapacity:count];
    
    // First get the image into your data buffer
    CGImageRef imageRef = [image CGImage];
    NSUInteger width = CGImageGetWidth(imageRef);
    NSUInteger height = CGImageGetHeight(imageRef);
    CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB();
    unsigned char *rawData = (unsigned char*) calloc(height * width * 4, sizeof(unsigned char));
    NSUInteger bytesPerPixel = 4;
    NSUInteger bytesPerRow = bytesPerPixel * width;
    NSUInteger bitsPerComponent = 8;
    CGContextRef context = CGBitmapContextCreate(rawData, width, height,
                                                 bitsPerComponent, bytesPerRow, colorSpace,
                                                 kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);
    CGColorSpaceRelease(colorSpace);
    
    CGContextDrawImage(context, CGRectMake(0, 0, width, height), imageRef);
    CGContextRelease(context);
    
    // Now your rawData contains the image data in the RGBA8888 pixel format.
    NSUInteger byteIndex = (bytesPerRow * y) + x * bytesPerPixel;
    for (int i = 0 ; i < count ; ++i)
    {
        CGFloat red   = (rawData[byteIndex]     * 1.0) / 255.0;
        CGFloat green = (rawData[byteIndex + 1] * 1.0) / 255.0;
        CGFloat blue  = (rawData[byteIndex + 2] * 1.0) / 255.0;
        CGFloat alpha = (rawData[byteIndex + 3] * 1.0) / 255.0;
        byteIndex += bytesPerPixel;
        
        //UIColor *acolor = [UIColor colorWithRed:red green:green blue:blue alpha:alpha];
        if (red > 0.9 && green > 0.9 && blue > 0.9 && alpha > 0.9)
        {
            [result addObject:[NSString stringWithFormat:@"1"]];
        }
        else
        {
            [result addObject:[NSString stringWithFormat:@"0"]];
        }
    }
    
    free(rawData);
    
    return result;
}


- (NSString *)OCRwithCharacterImageString:(NSString *)inputString
{
    
    NSMutableDictionary *alphabetDict = [NSMutableDictionary dictionary];
    NSMutableArray *alphabetDataArray = [[NSMutableArray alloc] init];
    
    NSString *a = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111000000000000000000001100011111100000000000000000011000011111100000000000000000011000111001100000000000000000011000110001100000000000000000011000110001100000000000000000011100110011000000000000000000011111111111000000000000000000001111111111100000000000000000000111111111100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *b = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111111111100000000000001111111111111111100000000000001111111111111111100000000000000000001100000011000000000000000000011000000001100000000000000000011000000001100000000000000000011000000001100000000000000000011000000011100000000000000000011100000111100000000000000000001111111111000000000000000000000111111110000000000000000000000011111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *c = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111100000000000000000000000111111110000000000000000000001111111111000000000000000000011110000111100000000000000000011100000011100000000000000000011000000001100000000000000000011000000001100000000000000000011000000001100000000000000000011000000001100000000000000000001100000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *d = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111100000000000000000000000111111111000000000000000000001111111111000000000000000000011110000011100000000000000000011100000001100000000000000000011000000001100000000000000000011000000001100000000000000000011000000011000000000000000000001100000011000000000000001111111111111111100000000000001111111111111111100000000000001111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *e = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111100000000000000000000000111111110000000000000000000001111111111000000000000000000011100110011100000000000000000011000110001100000000000000000011000110001100000000000000000011000110001100000000000000000011100110001100000000000000000001111110001100000000000000000001111110001100000000000000000000011110011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *f = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000011000000000000000000000000011111111111111100000000000000111111111111111100000000000001111111111111111100000000000001100011000000000000000000000001100011000000000000000000000001100011000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *g = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111100000000000000000000000111111111001100000000000000001111111111001110000000000000011110000011100110000000000000011100000001100110000000000000011000000001100110000000000000011000000001100110000000000000011000000011000110000000000000001100000011001110000000000000011111111111111100000000000000011111111111111000000000000000011111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *h = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111111111100000000000001111111111111111100000000000001111111111111111100000000000000000000110000000000000000000000000001100000000000000000000000000011000000000000000000000000000011000000000000000000000000000011111111111100000000000000000011111111111100000000000000000000111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *i = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110011111111111100000000000000110011111111111100000000000000110011111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *j = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000001100000000000000000000000000000110000000000000000000000000000110000000000000000000000000000110000000000110011111111111111110000000000110011111111111111100000000000110011111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *k = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111111111100000000000001111111111111111100000000000001111111111111111100000000000000000000000100000000000000000000000000001110000000000000000000000000011111000000000000000000000000110111110000000000000000000001100011111000000000000000000011000000111100000000000000000010000000011100000000000000000000000000001100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *l = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111111111100000000000001111111111111111100000000000001111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *m = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111100000000000000000011111111111100000000000000000011111111111100000000000000000000100000000000000000000000000001000000000000000000000000000011000000000000000000000000000011000000000000000000000000000011111111111100000000000000000011111111111100000000000000000001111111111100000000000000000000100000000000000000000000000001000000000000000000000000000011000000000000000000000000000011000000000000000000000000000011111111111100000000000000000011111111111100000000000000000001111111111100000000"];
    NSString *n = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111100000000000000000011111111111100000000000000000011111111111100000000000000000000110000000000000000000000000001100000000000000000000000000011000000000000000000000000000011000000000000000000000000000011111111111100000000000000000011111111111100000000000000000000111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *o = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111100000000000000000000000111111110000000000000000000001111111111000000000000000000011110000111100000000000000000011000000001100000000000000000011000000001100000000000000000011000000001100000000000000000011000000001100000000000000000011110000111100000000000000000001111111111000000000000000000000111111110000000000000000000000011111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *p = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111110000000000000011111111111111110000000000000011111111111111110000000000000001100000011000000000000000000011000000001100000000000000000011000000001100000000000000000011000000001100000000000000000011000000011100000000000000000011100000111100000000000000000001111111111000000000000000000000111111110000000000000000000000011111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *q = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111100000000000000000000000111111111000000000000000000001111111111000000000000000000011110000011100000000000000000011100000001100000000000000000011000000001100000000000000000011000000001100000000000000000011000000011000000000000000000001100000011000000000000000000011111111111111110000000000000011111111111111110000000000000011111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *r = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111100000000000000000011111111111100000000000000000011111111111100000000000000000000110000000000000000000000000001100000000000000000000000000011000000000000000000000000000011000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *s = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111000011000000000000000000001111100001100000000000000000011111110001100000000000000000011001110001100000000000000000011001111001100000000000000000011000111111100000000000000000001100011111000000000000000000000000001110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *t = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011000000000000000000000000001111111111110000000000000000001111111111111000000000000000001111111111111100000000000000000011000000011100000000000000000011000000001100000000000000000011000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *u = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111000000000000000000011111111111100000000000000000011111111111100000000000000000000000000001100000000000000000000000000001100000000000000000000000000011000000000000000000000000000110000000000000000000011111111111100000000000000000011111111111100000000000000000011111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *v = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000011110000000000000000000000000011111110000000000000000000000001111111100000000000000000000000001111111100000000000000000000000011111100000000000000000000000000011100000000000000000000000011111100000000000000000000001111100000000000000000000001111100000000000000000000000011110000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *w = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000011111000000000000000000000000011111111100000000000000000000000111111111100000000000000000000000111111100000000000000000000000000011100000000000000000000001111111100000000000000000011111111000000000000000000000011110000000000000000000000000011111111000000000000000000000011111111111100000000000000000000001111111100000000000000000000000000011100000000000000000000000111111100000000000000000000111111100000000000000000000011111000000000000000000000000011000000000000000000000000000000000000000000000000"];
    NSString *x = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000100000000000000000011000000001100000000000000000011110000011000000000000000000011111101110000000000000000000000111111100000000000000000000000011111100000000000000000000000011111110000000000000000000000111011111100000000000000000001100000111100000000000000000011000000001100000000000000000010000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *y = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000011110000000000000000000000000011111100000000010000000000000001111111000000110000000000000000011111111011110000000000000000000111111111110000000000000000000000111110000000000000000000000111111000000000000000000000011111000000000000000000000001111100000000000000000000000011110000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    NSString *z = [[NSString alloc] initWithFormat:@"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011000000011100000000000000000011000000111100000000000000000011000001111100000000000000000011000011111100000000000000000011000111101100000000000000000011001111001100000000000000000011011110001100000000000000000011111100001100000000000000000011111000001100000000000000000011110000001100000000000000000011100000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];
    
    [alphabetDataArray addObject:a];
    [alphabetDataArray addObject:b];
    [alphabetDataArray addObject:c];
    [alphabetDataArray addObject:d];
    [alphabetDataArray addObject:e];
    [alphabetDataArray addObject:f];
    [alphabetDataArray addObject:g];
    [alphabetDataArray addObject:h];
    [alphabetDataArray addObject:i];
    [alphabetDataArray addObject:j];
    [alphabetDataArray addObject:k];
    [alphabetDataArray addObject:l];
    [alphabetDataArray addObject:m];
    [alphabetDataArray addObject:n];
    [alphabetDataArray addObject:o];
    [alphabetDataArray addObject:p];
    [alphabetDataArray addObject:q];
    [alphabetDataArray addObject:r];
    [alphabetDataArray addObject:s];
    [alphabetDataArray addObject:t];
    [alphabetDataArray addObject:u];
    [alphabetDataArray addObject:v];
    [alphabetDataArray addObject:w];
    [alphabetDataArray addObject:x];
    [alphabetDataArray addObject:y];
    [alphabetDataArray addObject:z];
    
    NSArray *alphabet = [NSArray arrayWithObjects:@"a",@"b",@"c",@"d",@"e",@"f",@"g",@"h",@"i",@"j",@"k",@"l",@"m",@"n",@"o",@"p",@"q",@"r",@"s",@"t",@"u",@"v",@"w",@"x",@"y",@"z",nil];
    NSInteger index = 0;
    
    for(NSString *character in alphabet)
    {
        [alphabetDict setObject:[alphabetDataArray objectAtIndex:index] forKey:character];
        index ++;
    }
    
    [alphabetDict allKeysForObject:inputString];
    
    return [[alphabetDict allKeysForObject:inputString] objectAtIndex:0];
}

@end
